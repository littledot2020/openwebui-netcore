import{s as $e,p as H,a as Ae,f as Me,M as et,d as oe,c as Ne,g as Ie,h as ke,j as ue,i as Ue,r as ve,u as tt,Y as F,w as X,P as ot,o as st,t as D}from"../chunks/scheduler.7238b518.js";import{S as nt,i as lt,f as V,b as Te,d as Re,m as Be,a as Le,t as qe,e as De}from"../chunks/index.5768aeba.js";import{g as at}from"../chunks/globals.7f7f1b26.js";import{a as N}from"../chunks/Toaster.svelte_svelte_type_style_lang.93775e0f.js";import"../chunks/singletons.9daee91f.js";import{p as rt}from"../chunks/stores.54350edb.js";import{e as Ce,s as je,b as ge,a as We,L as Fe,O as Ve,l as it,m as ct,c as pt,j as ut,W as ft,f as dt}from"../chunks/index.e32116ac.js";import{v as Ge,s as mt,a as Ye,n as gt,o as ht}from"../chunks/index.fe6b9b61.js";import{h as _t,c as ze}from"../chunks/index.d9cb14a2.js";import{c as wt,b as he,u as He}from"../chunks/index.cdf12964.js";import{N as bt,M as St,c as yt}from"../chunks/index.1b77b317.js";import{M as Mt}from"../chunks/Messages.56e8619b.js";import"../chunks/create.d7af4d12.js";/* empty css                                                       */const{document:Je}=at;function It(o){var Se;let se,s,_,t,w,U,G,y,M,Y,I,ae,T,k,C,R,Z,u,z,A,re,J,j,E,B;Je.title=se=`\r
		`+(o[9]?`${o[9].length>30?`${o[9].slice(0,30)}...`:o[9]} | ${o[15]}`:`${o[15]}`)+`\r
	`;function i(n){o[25](n)}function r(n){o[26](n)}let ie={title:o[9],shareEnabled:o[12].length>0,chat:o[8],initNewChat:o[18]};o[0]!==void 0&&(ie.selectedModels=o[0]),o[4]!==void 0&&(ie.showModelSelector=o[4]),t=new bt({props:ie}),H.push(()=>V(t,"selectedModels",i)),H.push(()=>V(t,"showModelSelector",r));function K(n){o[27](n)}function _e(n){o[28](n)}function fe(n){o[29](n)}function we(n){o[30](n)}let x={chatId:o[13],selectedModels:o[0],selectedModelfiles:o[7],processing:kt,bottomPadding:o[11].length>0,suggestionPrompts:((Se=o[6])==null?void 0:Se.suggestionPrompts)??o[14].default_prompt_suggestions,sendPrompt:o[20],continueGeneration:o[23],regenerateResponse:o[22]};o[1]!==void 0&&(x.history=o[1]),o[12]!==void 0&&(x.messages=o[12]),o[2]!==void 0&&(x.autoScroll=o[2]),o[10]!==void 0&&(x.prompt=o[10]),I=new Mt({props:x}),H.push(()=>V(I,"history",K)),H.push(()=>V(I,"messages",_e)),H.push(()=>V(I,"autoScroll",fe)),H.push(()=>V(I,"prompt",we));function Ee(n){o[33](n)}function Pe(n){o[34](n)}function Oe(n){o[35](n)}function be(n){o[36](n)}let $={messages:o[12],submitPrompt:o[19],stopResponse:o[21]};return o[11]!==void 0&&($.files=o[11]),o[10]!==void 0&&($.prompt=o[10]),o[2]!==void 0&&($.autoScroll=o[2]),o[5]!==void 0&&($.selectedModel=o[5]),u=new St({props:$}),H.push(()=>V(u,"files",Ee)),H.push(()=>V(u,"prompt",Pe)),H.push(()=>V(u,"autoScroll",Oe)),H.push(()=>V(u,"selectedModel",be)),{c(){s=Ae(),_=Me("div"),Te(t.$$.fragment),G=Ae(),y=Me("div"),M=Me("div"),Y=Me("div"),Te(I.$$.fragment),Z=Ae(),Te(u.$$.fragment),this.h()},l(n){et("svelte-1123lr8",Je.head).forEach(oe),s=Ne(n),_=Ie(n,"DIV",{class:!0});var P=ke(_);Re(t.$$.fragment,P),G=Ne(P),y=Ie(P,"DIV",{class:!0});var v=ke(y);M=Ie(v,"DIV",{class:!0,id:!0});var L=ke(M);Y=Ie(L,"DIV",{class:!0});var ne=ke(Y);Re(I.$$.fragment,ne),ne.forEach(oe),L.forEach(oe),v.forEach(oe),P.forEach(oe),Z=Ne(n),Re(u.$$.fragment,n),this.h()},h(){ue(Y,"class","h-full w-full flex flex-col pt-2 pb-4"),ue(M,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0 max-w-full"),ue(M,"id","messages-container"),ue(y,"class","flex flex-col flex-auto"),ue(_,"class",R="min-h-screen max-h-screen "+(o[16]?"lg:max-w-[calc(100%-260px)]":"")+" w-full max-w-full flex flex-col")},m(n,d){Ue(n,s,d),Ue(n,_,d),Be(t,_,null),ve(_,G),ve(_,y),ve(y,M),ve(M,Y),Be(I,Y,null),o[31](M),Ue(n,Z,d),Be(u,n,d),j=!0,E||(B=tt(M,"scroll",o[32]),E=!0)},p(n,d){var ne;(!j||d[0]&33280)&&se!==(se=`\r
		`+(n[9]?`${n[9].length>30?`${n[9].slice(0,30)}...`:n[9]} | ${n[15]}`:`${n[15]}`)+`\r
	`)&&(Je.title=se);const P={};d[0]&512&&(P.title=n[9]),d[0]&4096&&(P.shareEnabled=n[12].length>0),d[0]&256&&(P.chat=n[8]),!w&&d[0]&1&&(w=!0,P.selectedModels=n[0],F(()=>w=!1)),!U&&d[0]&16&&(U=!0,P.showModelSelector=n[4],F(()=>U=!1)),t.$set(P);const v={};d[0]&8192&&(v.chatId=n[13]),d[0]&1&&(v.selectedModels=n[0]),d[0]&128&&(v.selectedModelfiles=n[7]),d[0]&2048&&(v.bottomPadding=n[11].length>0),d[0]&16448&&(v.suggestionPrompts=((ne=n[6])==null?void 0:ne.suggestionPrompts)??n[14].default_prompt_suggestions),!ae&&d[0]&2&&(ae=!0,v.history=n[1],F(()=>ae=!1)),!T&&d[0]&4096&&(T=!0,v.messages=n[12],F(()=>T=!1)),!k&&d[0]&4&&(k=!0,v.autoScroll=n[2],F(()=>k=!1)),!C&&d[0]&1024&&(C=!0,v.prompt=n[10],F(()=>C=!1)),I.$set(v),(!j||d[0]&65536&&R!==(R="min-h-screen max-h-screen "+(n[16]?"lg:max-w-[calc(100%-260px)]":"")+" w-full max-w-full flex flex-col"))&&ue(_,"class",R);const L={};d[0]&4096&&(L.messages=n[12]),!z&&d[0]&2048&&(z=!0,L.files=n[11],F(()=>z=!1)),!A&&d[0]&1024&&(A=!0,L.prompt=n[10],F(()=>A=!1)),!re&&d[0]&4&&(re=!0,L.autoScroll=n[2],F(()=>re=!1)),!J&&d[0]&32&&(J=!0,L.selectedModel=n[5],F(()=>J=!1)),u.$set(L)},i(n){j||(Le(t.$$.fragment,n),Le(I.$$.fragment,n),Le(u.$$.fragment,n),j=!0)},o(n){qe(t.$$.fragment,n),qe(I.$$.fragment,n),qe(u.$$.fragment,n),j=!1},d(n){n&&(oe(s),oe(_),oe(Z)),De(t),De(I),o[31](null),De(u,n),E=!1,B()}}}let kt="";function vt(o,se,s){let _,t,w,U,G,y,M,Y,I;X(o,Ce,e=>s(13,_=e)),X(o,je,e=>s(40,t=e)),X(o,ct,e=>s(42,U=e)),X(o,rt,e=>s(43,G=e)),X(o,pt,e=>s(14,y=e)),X(o,ut,e=>s(24,M=e)),X(o,ft,e=>s(15,Y=e)),X(o,dt,e=>s(16,I=e));const ae=ot("i18n");X(o,ae,e=>s(41,w=e));let T=!1,k=!0,C,R=null,Z=!0,u=[""],z="",A=null,re={},J=null,j="",E="",B=[],i=[],r={messages:{},currentId:null};st(async()=>{await ie()});const ie=async()=>{var f;R!==null&&(await ze(localStorage.token,R),R=null),window.history.replaceState(r.state,"","/"),await Ce.set(""),s(2,k=!0),s(9,j=""),s(12,i=[]),s(1,r={messages:{},currentId:null}),G.url.searchParams.get("models")?s(0,u=(f=G.url.searchParams.get("models"))==null?void 0:f.split(",")):t!=null&&t.models?s(0,u=t==null?void 0:t.models):y!=null&&y.default_models?s(0,u=y==null?void 0:y.default_models.split(",")):s(0,u=[""]),G.url.searchParams.get("q")&&(s(10,E=G.url.searchParams.get("q")??""),E&&(await D(),_e(E))),s(0,u=u.map(m=>U.map(l=>l.id).includes(m)?m:""));let e=JSON.parse(localStorage.getItem("settings")??"{}");je.set({...e});const c=document.getElementById("chat-textarea");setTimeout(()=>c==null?void 0:c.focus(),0)},K=async()=>{await D(),C&&s(3,C.scrollTop=C.scrollHeight,C)},_e=async(e,c=null)=>{if(console.log("submitPrompt",_),s(0,u=u.map(f=>U.map(m=>m.id).includes(f)?f:"")),u.includes(""))N.error(w.t("Model not selected"));else if(i.length!=0&&i.at(-1).done!=!0)console.log("wait");else if(B.length>0&&B.filter(f=>f.upload_status===!1).length>0)N.error(w.t("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready."));else{document.getElementById("chat-textarea").style.height="";let f=Ge(),m={id:f,parentId:i.length!==0?i.at(-1).id:null,childrenIds:[],role:"user",user:c??void 0,content:e,files:B.length>0?B:void 0,timestamp:Math.floor(Date.now()/1e3)};s(1,r.messages[f]=m,r),s(1,r.currentId=f,r),i.length!==0&&r.messages[i.at(-1).id].childrenIds.push(f),await D(),i.length==1&&(t.saveChatHistory??!0?(s(8,J=await wt(localStorage.token,{id:_,title:w.t("New Chat"),models:u,system:t.system??void 0,options:{...t.options??{}},messages:i,history:r,tags:[],timestamp:Date.now()})),await ge.set(await he(localStorage.token)),await Ce.set(J.id)):await Ce.set("local"),await D()),s(10,E=""),s(11,B=[]),await fe(e,f)}},fe=async(e,c)=>{const f=JSON.parse(JSON.stringify(_));await Promise.all((z!==""?[z.id]:u).map(async m=>{console.log("modelId",m);const l=U.filter(h=>h.id===m).at(0);if(l){let h=Ge(),b={parentId:c,id:h,childrenIds:[],role:"assistant",content:"",model:l.id,timestamp:Math.floor(Date.now()/1e3)};s(1,r.messages[h]=b,r),s(1,r.currentId=h,r),c!==null&&s(1,r.messages[c].childrenIds=[...r.messages[c].childrenIds,h],r),l!=null&&l.external?await x(l,e,h,f):l&&await we(l,e,h,f)}else N.error(w.t("Model {{modelId}} not found",{modelId:m}))})),await ge.set(await he(localStorage.token))},we=async(e,c,f,m)=>{var Q,de;e=e.id;const l=r.messages[f];await D(),K();const h=[t.system?{role:"system",content:t.system}:void 0,...i].filter(p=>p).map((p,O,pe)=>{var g;const q={role:p.role,content:pe.length-2!==O?p.content:(p==null?void 0:p.raContent)??p.content},W=(g=p.files)==null?void 0:g.filter(a=>a.type==="image").map(a=>a.url.slice(a.url.indexOf(",")+1));return W&&W.length>0&&p.role==="user"&&(q.images=W),q});let b=-1;h.forEach((p,O)=>{p.images&&(b=O)}),h.forEach((p,O)=>{O!==b&&delete p.images});const ee=i.filter(p=>(p==null?void 0:p.files)??null).map(p=>p.files.filter(O=>O.type==="doc"||O.type==="collection")).flat(1),[S,ce]=await _t(localStorage.token,{model:e,messages:h,options:{...t.options??{},stop:((Q=t==null?void 0:t.options)==null?void 0:Q.stop)??void 0?t.options.stop.map(p=>decodeURIComponent(JSON.parse('"'+p.replace(/\"/g,'\\"')+'"'))):void 0},format:t.requestFormat??void 0,keep_alive:t.keepAlive??void 0,docs:ee.length>0?ee:void 0,citations:ee.length>0});if(S&&S.ok){console.log("controller",ce);const p=S.body.pipeThrough(new TextDecoderStream).pipeThrough(mt(`
`)).getReader();for(;;){const{value:O,done:pe}=await p.read();if(pe||T||m!==_){l.done=!0,s(12,i),s(1,r),T&&(ce.abort("User: Stop Response"),await ze(localStorage.token,R)),R=null;break}try{let q=O.split(`
`);for(const W of q)if(W!==""){console.log(W);let g=JSON.parse(W);if("citations"in g){l.citations=g.citations;continue}if("detail"in g)throw g;if("id"in g)console.log(g),R=g.id;else if(g.done==!1){if(l.content==""&&g.message.content==`
`)continue;l.content+=g.message.content,s(12,i),s(1,r)}else{if(l.done=!0,l.content==""&&(l.error=!0,l.content="Oops! No text generated from Ollama, Please try again."),l.context=g.context??null,l.info={total_duration:g.total_duration,load_duration:g.load_duration,sample_count:g.sample_count,sample_duration:g.sample_duration,prompt_eval_count:g.prompt_eval_count,prompt_eval_duration:g.prompt_eval_duration,eval_count:g.eval_count,eval_duration:g.eval_duration},s(12,i),s(1,r),t.notificationEnabled&&!document.hasFocus()){const a=new Notification(A?`${A.title.charAt(0).toUpperCase()+A.title.slice(1)}`:`${e}`,{body:l.content,icon:(A==null?void 0:A.imageUrl)??`${We}/static/favicon.png`})}t.responseAutoCopy&&Ye(l.content),t.responseAutoPlayback&&(await D(),(de=document.getElementById(`speak-button-${l.id}`))==null||de.click())}}}catch(q){console.log(q),"detail"in q&&N.error(q.detail);break}k&&K()}_==m&&(t.saveChatHistory??!0)&&(s(8,J=await He(localStorage.token,m,{messages:i,history:r})),await ge.set(await he(localStorage.token)))}else{if(S!==null){const p=await S.json();console.log(p),"detail"in p?(N.error(p.detail),l.content=p.detail):(N.error(p.error),l.content=p.error)}else N.error(w.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"})),l.content=w.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"});l.error=!0,l.content=w.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"}),l.done=!0,s(12,i),s(1,r)}if(T=!1,await D(),k&&K(),i.length==2&&i.at(1).content!==""){window.history.replaceState(r.state,"",`/c/${m}`);const p=await be(c);await $(m,p)}},x=async(e,c,f,m)=>{var S,ce,Q,de,p,O,pe,q,W,g;const l=r.messages[f],h=i.filter(a=>(a==null?void 0:a.files)??null).map(a=>a.files.filter(le=>le.type==="doc"||le.type==="collection")).flat(1);console.log(h),K();const[b,ee]=await gt(localStorage.token,{model:e.id,stream:!0,messages:[t.system?{role:"system",content:t.system}:void 0,...i].filter(a=>a).map((a,le,me)=>{var ye;return{role:a.role,...((ye=a.files)==null?void 0:ye.filter(te=>te.type==="image").length)>0&&a.role==="user"?{content:[{type:"text",text:me.length-1!==le?a.content:(a==null?void 0:a.raContent)??a.content},...a.files.filter(te=>te.type==="image").map(te=>({type:"image_url",image_url:{url:te.url}}))]}:{content:me.length-1!==le?a.content:(a==null?void 0:a.raContent)??a.content}}}),seed:((S=t==null?void 0:t.options)==null?void 0:S.seed)??void 0,stop:((ce=t==null?void 0:t.options)==null?void 0:ce.stop)??void 0?(Q=t==null?void 0:t.options)==null?void 0:Q.stop.map(a=>decodeURIComponent(JSON.parse('"'+a.replace(/\"/g,'\\"')+'"'))):void 0,temperature:((de=t==null?void 0:t.options)==null?void 0:de.temperature)??void 0,top_p:((p=t==null?void 0:t.options)==null?void 0:p.top_p)??void 0,num_ctx:((O=t==null?void 0:t.options)==null?void 0:O.num_ctx)??void 0,frequency_penalty:((pe=t==null?void 0:t.options)==null?void 0:pe.repeat_penalty)??void 0,max_tokens:((q=t==null?void 0:t.options)==null?void 0:q.num_predict)??void 0,docs:h.length>0?h:void 0,citations:h.length>0},((W=e==null?void 0:e.source)==null?void 0:W.toLowerCase())==="litellm"?`${Fe}/v1`:`${Ve}`);if(await D(),K(),b&&b.ok&&b.body){const a=await yt(b.body,t.splitLargeChunks);for await(const le of a){const{value:me,done:ye,citations:te}=le;if(ye||T||m!==_){l.done=!0,s(12,i),s(1,r),T&&ee.abort("User: Stop Response");break}if(te){l.citations=te;continue}l.content==""&&me==`
`||(l.content+=me,s(12,i),s(1,r),t.notificationEnabled&&!document.hasFocus()&&new Notification(`OpenAI ${e}`,{body:l.content,icon:`${We}/static/favicon.png`}),t.responseAutoCopy&&Ye(l.content),t.responseAutoPlayback&&(await D(),(g=document.getElementById(`speak-button-${l.id}`))==null||g.click()),k&&K())}_==m&&(t.saveChatHistory??!0)&&(s(8,J=await He(localStorage.token,m,{messages:i,history:r})),await ge.set(await he(localStorage.token)))}else{if(b!==null){const a=await b.json();console.log(a),"detail"in a?(N.error(a.detail),l.content=a.detail):"message"in a.error?(N.error(a.error.message),l.content=a.error.message):(N.error(a.error),l.content=a.error)}else N.error(w.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:e.name??e.id})),l.content=w.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:e.name??e.id});l.error=!0,l.content=w.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:e.name??e.id}),l.done=!0,s(12,i),s(1,r)}if(T=!1,await D(),k&&K(),i.length==2){window.history.replaceState(r.state,"",`/c/${m}`);const a=await be(c);await $(m,a)}},Ee=()=>{T=!0,console.log("stopResponse")},Pe=async()=>{if(console.log("regenerateResponse"),i.length!=0&&i.at(-1).done==!0){i.splice(i.length-1,1),s(12,i),s(1,r);let e=i.at(-1),c=e.content;await fe(c,e.id)}},Oe=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(_));if(i.length!=0&&i.at(-1).done==!0){const c=r.messages[r.currentId];c.done=!1,await D();const f=U.filter(m=>m.id===c.model).at(0);f&&(f!=null&&f.external?await x(f,r.messages[c.parentId].content,c.id,e):await we(f,r.messages[c.parentId].content,c.id,e))}else N.error(w.t("Model {{modelId}} not found",{modelId}))},be=async e=>{var c,f,m,l,h;if(((c=t==null?void 0:t.title)==null?void 0:c.auto)??!0){const b=U.find(Q=>Q.id===u[0]),ee=(b==null?void 0:b.external)??!1?((f=t==null?void 0:t.title)==null?void 0:f.modelExternal)??u[0]:((m=t==null?void 0:t.title)==null?void 0:m.model)??u[0],S=U.find(Q=>Q.id===ee);return console.log(S),await ht(localStorage.token,((l=t==null?void 0:t.title)==null?void 0:l.prompt)??w.t("Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title':")+" {{prompt}}",ee,e,(S==null?void 0:S.external)??!1?((h=S==null?void 0:S.source)==null?void 0:h.toLowerCase())==="litellm"?`${Fe}/v1`:`${Ve}`:`${it}/v1`)}else return`${e}`},$=async(e,c)=>{e===_&&s(9,j=c),(t.saveChatHistory??!0)&&(s(8,J=await He(localStorage.token,e,{title:c})),await ge.set(await he(localStorage.token)))};function Se(e){u=e,s(0,u)}function n(e){Z=e,s(4,Z)}function d(e){r=e,s(1,r)}function P(e){i=e,s(12,i),s(1,r)}function v(e){k=e,s(2,k)}function L(e){E=e,s(10,E)}function ne(e){H[e?"unshift":"push"](()=>{C=e,s(3,C)})}const Ke=e=>{s(2,k=C.scrollHeight-C.scrollTop<=C.clientHeight+5)};function Qe(e){B=e,s(11,B)}function Xe(e){E=e,s(10,E)}function Ze(e){k=e,s(2,k)}function xe(e){z=e,s(5,z)}return o.$$.update=()=>{if(o.$$.dirty[0]&16777217&&s(6,A=u.length===1&&M.filter(e=>e.tagName===u[0]).length>0?M.filter(e=>e.tagName===u[0])[0]:null),o.$$.dirty[0]&16777217&&s(7,re=u.reduce((e,c,f,m)=>{var h;const l=((h=M.filter(b=>b.tagName===c))==null?void 0:h.at(0))??void 0;return{...e,...l&&{[c]:l}}},{})),o.$$.dirty[0]&2)if(r.currentId!==null){let e=[],c=r.messages[r.currentId];for(;c!==null;)e.unshift({...c}),c=c.parentId!==null?r.messages[c.parentId]:null;s(12,i=e)}else s(12,i=[])},[u,r,k,C,Z,z,A,re,J,j,E,B,i,_,y,Y,I,ae,ie,_e,fe,Ee,Pe,Oe,M,Se,n,d,P,v,L,ne,Ke,Qe,Xe,Ze,xe]}class Jt extends nt{constructor(se){super(),lt(this,se,vt,It,$e,{},null,[-1,-1])}}export{Jt as component};
